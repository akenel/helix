#!/usr/bin/env bash
set -euo pipefail

# Load optional environment file
ENV_FILE="${ENV_FILE:-bootstrap/support/identity.env}"
[[ -f "$ENV_FILE" ]] && source "$ENV_FILE"

COMMAND="${1:-}"
TARGET="${2:-}"

# Helper paths
SCRIPT_DIR="$(dirname "$(realpath "$0")")"
ADDON_CONFIGS_DIR="${SCRIPT_DIR}/addon-configs"
CONFIG_FILE="${ADDON_CONFIGS_DIR}/config.yaml"
LOG_DIR="${ADDON_CONFIGS_DIR}/logs"
ROOT_DIR="$(realpath "${SCRIPT_DIR}/../..")"
FUNCS_DIR="${SCRIPT_DIR}/functions"
print_random_banner
# Source function libraries if they exist
[[ -f "${FUNCS_DIR}/postgres.sh" ]] && source "${FUNCS_DIR}/postgres.sh"
[[ -f "${FUNCS_DIR}/keycloak.sh" ]] && source "${FUNCS_DIR}/keycloak.sh"
[[ -f "${FUNCS_DIR}/vault.sh" ]] && source "${FUNCS_DIR}/vault.sh"

# CLI Routing
case "$COMMAND" in
  deploy)
    case "$TARGET" in
      identity)
        bash bootstrap/deployment-phases/04_deploy_identity_stack.sh
        ;;
      postgres)
        deploy_postgres
        store_postgres_secret
        ;;
      keycloak)
        deploy_keycloak
        store_keycloak_secrets
        ;;
      vault)
        deploy_vault
        ;;
      *)
        echo "‚ùå Unknown deploy target: $TARGET"
        ;;
    esac
    ;;
  cleanup)
    echo "üßπ Cleanup not yet implemented. Try: helixctl cleanup identity"
    ;;
  status)
    echo "üì° Cluster Status:"
    kubectl get pods -n "${NAMESPACE:-identity}"
    ;;
  doctor)
    echo "üß† Helix Diagnostic Report"
    echo "üì¶ Context: $(kubectl config current-context)"
    echo "üìÅ Directory: $(pwd)"
    echo "üìÑ ENV_FILE: $ENV_FILE"
    echo "üîç Vault Token File: $VAULT_ROOT_TOKEN_FILE"
    echo "üß™ Kubeconfig: ${KUBECONFIG:-$HOME/.helix/kubeconfig.yaml}"
    ;;
  help|"")
    cat <<EOF
üì¶ helixctl ‚Äì Local Developer Cluster Orchestrator

Usage:
  helixctl <command> [target]

Commands:
  deploy identity    ‚Üí Deploy Vault + Postgres + Keycloak
  deploy vault       ‚Üí Deploy Vault only
  deploy postgres    ‚Üí Deploy PostgreSQL only
  deploy keycloak    ‚Üí Deploy Keycloak only
  cleanup [target]   ‚Üí Clean up deployment (coming soon)
  status             ‚Üí Show identity pod status
  doctor             ‚Üí Diagnostic info
  help               ‚Üí Show this help message

Examples:
  helixctl deploy identity
  helixctl deploy keycloak
  helixctl status
EOF
    ;;
  *)
    echo "‚ùå Unknown command: $COMMAND"
    echo "Run 'helixctl help' for usage."
    exit 1
    ;;
esac
# End of CLI routing